<h1>Seguros Fechados</h1>
<br />
<style type="text/css">
#delobs {
    left:150px;
    margin:0;
    padding:10px;
    position:absolute;
    top:50%;
    width:650px;
    background-color: #ffffff;
    border: solid #000 1px;
}
</style>
<?php if(count($flashMessages)) : ?>
<div class="control-group error">
<ul class="help-inline">
    <?php foreach ($flashMessages as $msg) : ?>
    <li><?php echo $msg; ?></li>
    <?php endforeach; ?>
</ul>
</div>
<?php endif; ?>
<?php

    $user = $this->UserIdentity('LivrariaAdmin');
    $form = $this->form; 
    $form->setAttribute('action', $this->url($this->matchedRouteName,$this->params));
    $form->prepare();
    echo 
    $this->FormDefault(['legend' => 'Filtro(s)'],'inicio',$this, $form),
        "\r<td>",
            $this->FormDefault(['ajaxStatus', 'subOpcao','autoComp','user','locador','locatario'], 'hidden'),
            $this->FormDefault(['name' => 'locadorNome','icone' => 'icon-search','js' => 'autoCompLocador()','span' => "popLocador' style='position:absolute"],'icone'),
        "</td>\r<td>",
            $this->FormDefault(['name' => 'locatarioNome','icone' => 'icon-search','js' => 'autoCompLocatario()','span' => "popLocatario' style='position:absolute"],'icone'),
        "</td>\r<td>",
            $this->FormDefault(['refImovel' => 'text']),
        "</td><td style='vertical-align: middle;' rowspan='3'>\r",
            $this->FormDefault(['enviar'], 'submitOnly'),
        "</td>\r",
    "</tr><tr>\r",
        "\r<td>",
            $this->FormDefault([
                'name' => 'usuarioNome',
                'icone' => 'icon-search',
                'js' => 'autoCompUsuario()',
                'span' => "popUser' style='position:absolute"],'icone'),
        "</td>\r<td>",
            $this->FormDefault(['dataI'], 'calend'),
        "</td>\r<td>",
            $this->FormDefault(['dataF'], 'calend'),
        "</td>\r<td>",
        "</td>\r",
    "</tr><tr>\r",
        "<td>\r",
            $this->FormDefault(['administradora'=>'hidden']),
            $this->FormDefault(['name' => 'administradoraDesc','icone' => 'icon-search','js' => 'autoCompAdministradora()','span' => "popAdministradora' style='position:absolute"],'icone'),
        "</td><td>\r",
            $this->FormDefault(['status'=>'radio']),
        "</td><td>\r",
            ($user->getTipo() == 'admin')?$this->FormDefault(['validade'=>'radio']):'',
        "</td><td>\r",
        "</td>\r",

    $this->FormDefault([],'fim');

$coluns = array(
    'Ação',
    'Numero',
    'Status',
    'Ref Imovél',
    'Locador',
    'Locatário',
    'Local do Risco',
    'Inicio',
    'Atividade',
    'Valor',
);
$td     = array(
    'nowrap',
    'nowrap class="r"',
    'nowrap',
    'nowrap',
    'nowrap',
    'nowrap',
    'nowrap',
    'nowrap',
    'nowrap',
    'nowrap'
);  
echo $this->ViewIndex('table'),
     $this->ViewIndex('thead', array('coluns' => $coluns, 'tdopt' => $td,'editLine' => 'First'));

$lambda = function($value){
        echo "\t<td>",
                '<span class="add-on hand" onClick="printPdf(\'', $value, '\')"><i class="icon-print"></i>Imprimir</span>',
             "</td>\n";   
    };

$lambda = function($value,&$data){
        if($data[2] == "C"){
            echo "\t<td nowrap>",
                    '<span class="add-on hand" onClick="getLogs(\'', $value, '\')"><i class="icon-eye-open"></i>Logs</span>',
                 "</td>\n";   
        }
        if($data[2] == "A" or $data[2] == "R" or $data[2] == "I"){
            echo "\t<td nowrap>",
                    '<span class="add-on hand" onClick="printPdf(\'', $value, '\')"><i class="icon-print"></i>Imprimir</span>',
                    '<span class="add-on hand" onClick="del(\'', $value, '\')"><i class="icon-remove"></i>Deletar</span>',
                 "</td>\n";   
        }
                   
    };    
$this->ViewIndex('setFuncEdit',$lambda);    
    
foreach($this->data as $entity){ 
    $linha = array(
        $entity->getId(),
        $entity->getId() .'/'. $entity->getCodAno(),
        $entity->getStatus(),
        $entity->getRefImovel(),
        $entity->getLocadorNome(),
        $entity->getLocatarioNome(),
        $entity->getImovel(),
        $entity->getInicio(),
        $entity->getAtividade(),
        $entity->floatToStr('premioTotal')
    );
    echo $this->ViewIndex('line',array('data' => $linha));
}
echo $this->ViewIndex('close');
?>
<br />
<form name="form" id="form" method="POST">
    <input type="hidden" name="subOpcao" id="subOpcao2">
    <input type="hidden" name="id" id="id2">
    <input type="hidden" name="fechados" id="fechados">
<div id="delobs">
    <table width="100%">
        <tr>
            <td>
                <div class="input-append" id="popobservacao">
                    <label for="motivoNaoFechou">Motivo do não fechamento.</label>
                    <textarea name="motivoNaoFechou" id="motivoNaoFechou" rows="6" class="span6"></textarea>
                </div>
            </td>
            <td valign='top'>
                <a href="javascript:desistir()"><i class="icon-backward"></i>Desisitir!</a>
                <br><br><br><a href="javascript:deleltar();"><i class="icon-trash"></i>Finalizar!</a>
            </td>
        </tr>
    </table>
</div>  
</form>
<script language="javascript">
    var dateFormat = 'dd/mm/yyyy';
    var formName = '<?php echo $this->formName ?>';
    function edit(id){
        document.getElementById('id2').value = id ;
        var tar = "<?php echo $this->url($this->matchedRouteName,array('controller'=> $this->params['controller'],'action'=>'edit')); ?>";
        envia(tar,'editar');
    }    
    function getLogs(id){
        document.getElementById('id2').value = id ;
        document.getElementById('fechados').value = id ;
        var tar = "<?php echo $this->url($this->matchedRouteName,array('controller'=> 'logs','action'=>'logFechados')); ?>";
        envia(tar,id);        
    }
    function del(id){
        var motivo = document.getElementById('delobs');
        motivo.style.display = 'none';
        var msg = "Deseja realmente cancelar este seguro fechado?";
        if(!confirm(msg))return;
        motivo.style.display = 'block';
        document.getElementById('id2').value = id ;
    }  
    function desistir(){
        document.getElementById('delobs').style.display='none';
        document.getElementById('id2').value = '' ;
    }
    function deleltar(){
        var id = document.getElementById('id2').value;
        var obs = document.getElementById('motivoNaoFechou').value;
        if(obs == ''){
            alert('Digite o motivo por favor!!!');
            return;
        }
        if(id == '')return;
        var tar = "<?php echo $this->url($this->matchedRouteName,array('controller'=> $this->params['controller'],'action'=>'delete')); ?>";
        envia(tar,id);        
    }
    function printPdf(id){
        var tar = "<?php echo $this->url($this->matchedRouteName,array('controller'=> $this->params['controller'],'action'=>'imprimiSeguro')); ?>";
        document.getElementById('id2').value = id ;
        envia(tar,id,null,'new');  
        
    } 
    function autoCompUsuario(){
        document.getElementById('autoComp').value = 'usuarioNome';
        var filtros = 'autoComp,usuarioNome';
        var servico = "<?php echo $this->url('livraria-admin',array('controller'=>'users','action'=>'autoComp')); ?>";
        var returns = Array('user','usuarioNome');
        var functionCall = 'buscar()';
        autoComp2(filtros,servico,'popUser',returns,'2',functionCall);
    }
    function autoCompAdministradora(){
        var filtros = 'administradoraDesc';
        var servico = "<?php echo $this->url('livraria-admin',array('controller'=>'administradoras','action'=>'autoComp')); ?>";
        var returns = Array('administradora','administradoraDesc');
        var functionCall = 'buscar()';
        autoComp2(filtros,servico,'popAdministradora',returns,'2',functionCall);
    }

    function autoCompLocador(){
        $('#autoComp').val('locadorNome');
        var filtros = 'locadorNome,administradora';
        var servico = "<?php echo $this->url('livraria-admin',array('controller'=>'locadors','action'=>'autoComp')); ?>";
        var returns = Array('locador','locadorNome');
        var functionCall = '';
        autoComp2(filtros,servico,'popLocador',returns,'4',functionCall);
    }

    function autoCompLocatario(){
        $('#autoComp').val('locatarioNome');
        var filtros = 'locatarioNome,autoComp';
        var servico = "<?php echo $this->url('livraria-admin',array('controller'=>'locatarios','action'=>'autoComp')); ?>";
        var returns = Array('locatario','locatarioNome');
        var functionCall = '';
        autoComp2(filtros,servico,'popLocatario',returns,'4',functionCall);
    }
    function buscar(){
        if($('#locadorNome').val() == ''){
            $('#locador').val('');
        }
        if($('#locatarioNome').val() == ''){
            $('#locatario').val('');
        }
        if($('#usuarioNome').val() == ''){
            $('#user').val('');
        }
        if($('#administradoraDesc').val() == ''){
            $('#administradora').val('');
        }
        if(($('#administradora').val() == '')&&($('#dataI').val() == '')&&($('#locatario').val() == '')&&($('#locador').val() == '')){
            alert('Atenção é necessário preencher alguns filtro:\n Ex: Administradora ou Periodo ou Locador or Locatario!');
            return false;
        }
        var tar = "<?php echo $this->url($this->matchedRouteName,array('controller'=> $this->params['controller'],'action'=>'listarFechados')); ?>";
        envia(tar,'buscar',formName);
        return false;
    }   

    document.getElementById('delobs').style.display = 'none';
    
    $(document).ready(function(){
        var y_fixo = 250 + $("#delobs").offset().top;
        $(window).scroll(function () {
            $("#delobs").stop().animate({
                top: y_fixo+$(document).scrollTop()+"px"
                },{duration:500,queue:false}
            );
        });
    });
</script>

<?php echo $this->paginationControl($this->data,'Sliding','paginator',array('route' => $this->route)); ?>